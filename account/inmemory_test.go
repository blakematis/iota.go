package account_test

import (
	"github.com/iotaledger/iota.go/account"
	"github.com/iotaledger/iota.go/transaction"
	"github.com/iotaledger/iota.go/trinary"
	. "github.com/onsi/ginkgo"
	. "github.com/onsi/gomega"
	"strings"
)

var emptyAddr = strings.Repeat("9", 81)

var _ = Describe("InMemory", func() {

	var zeroValBundleTrytes = []trinary.Trytes{
		"VDD999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999FNXCXZCECVIXHIBZKIFOPPWRKBC9BSN9B9QOTREKIJSBVSBLSETYPQOQSGTVWDDKHIWITNFUDWFFXUXTA999999999999999999999999999GHY9QLLL9XNY999999999999999ZI9FN9D99999999999999999999FPBVYDWIHZHJLBRQVZBTWEXIOBGTDYIUPQPBI9HIVVWGIDADHGFQOO9OPWYJVXJBIDHIHIPOCKHUQUCF9RDGYDVOGMSDQCBXLTLONMBVRLATCCLKPCCQRVFGPTVVRJPAITAKTFS9MLUKPPDCGJSPROOAYXKPO99999CEXUIXWFMUDXDNVGWIPCEDQD99LDAYNNYVUXLEZECXLBPLYAIKGWLCYEYPAXGKEW9REOOVFHEB9PA9999SHY9QLLL9XNY999999999999999ROUSUMMLE999999999MMMMMMMMMXRGQHAZWFAEVOAZ9VGEDQHRNZMC",
	}
	tx, err := transaction.AsTransactionObject(zeroValBundleTrytes[0])
	if err != nil {
		panic(err)
	}

	store := account.NewInMemoryStore()

	var state *account.AccountState
	It("loads correctly an empty account", func() {
		var err error
		state, err = store.LoadAccount(id)
		Expect(err).ToNot(HaveOccurred())
		Expect(state.IsNew()).To(BeTrue())
	})

	Context("addresses", func() {
		It("marks deposit addresses", func() {
			err := store.MarkDepositAddresses(id, 1)
			Expect(err).ToNot(HaveOccurred())
			state, err = store.LoadAccount(id)
			Expect(err).ToNot(HaveOccurred())
			Expect(state.UsedAddresses).To(Equal([]int64{-1}))
		})
	})

	Context("AddPendingTransfer()", func() {
		It("adds the pending zero value transfer to the store", func() {
			err := store.AddPendingTransfer(id, tx.Hash, zeroValBundleTrytes)
			Expect(err).ToNot(HaveOccurred())
		})
	})

	Context("GetPendingTransfers()", func() {
		It("returns all pending transfers", func() {
			_, bndls, err := store.GetPendingTransfers(id)
			Expect(err).ToNot(HaveOccurred())
			Expect(bndls[0][0].Address).To(Equal(tx.Address))
		})
	})

	Context("AddTailHash()", func() {
		It("adds the given tail hash", func() {
			newTail := strings.Repeat("A", 81)
			err := store.AddTailHash(id, tx.Hash, newTail)
			Expect(err).ToNot(HaveOccurred())
			state, err = store.LoadAccount(id)
			Expect(err).ToNot(HaveOccurred())
			Expect(state.PendingTransfers[tx.Hash].Tails[1]).To(Equal(newTail))
		})
	})

	Context("RemovePendingTransfer()", func() {
		It("removes the given transfer", func() {
			err := store.RemovePendingTransfer(id, tx.Hash)
			Expect(err).ToNot(HaveOccurred())
			state, err = store.LoadAccount(id)
			Expect(err).ToNot(HaveOccurred())
			Expect(len(state.PendingTransfers)).To(Equal(0))
			_, bndls, err := store.GetPendingTransfers(id)
			Expect(err).ToNot(HaveOccurred())
			Expect(len(bndls)).To(Equal(0))
		})
	})
})
